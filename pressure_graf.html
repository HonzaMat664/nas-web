<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Tlak – korekce (3 dny)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: sans-serif; margin: 20px; }
#info { margin: 10px 0; color: #444; }
</style>
</head>

<body>

<h1>Tlak – korekce (poslední 3 dny)</h1>
<div id="info">Načítám CSV…</div>
<canvas id="chart" height="120"></canvas>

<script>
fetch("pressure_correction.csv")
  .then(r => {
    if (!r.ok) throw "CSV nelze načíst";
    return r.text();
  })
  .then(text => {
    const info = document.getElementById("info");

    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) throw "CSV nemá data";

    const header = lines.shift().split(",");
    info.innerHTML =
      "Sloupce CSV:<br>" +
      header.join("<br>") +
      "<br><br>Řádků: " + lines.length;

    const col = name => header.indexOf(name);

    const iTime  = col("timestamp");
    const iMsl   = col("pressure_msl_calc");
    const iRef   = col("pressure_ref_chotusice");
    const iFinal = col("pressure_final_hpa");

    if (iTime < 0) throw "Chybí sloupec timestamp";

    const limit = Date.now() - 3 * 24 * 3600 * 1000;

    let labels = [], msl = [], ref = [], fin = [];

    lines.forEach(l => {
      const c = l.split(",");
      const t = new Date(c[iTime].replace(" ", "T")).getTime();
      if (isNaN(t) || t < limit) return;

      labels.push(new Date(t).toLocaleString("cs-CZ"));
      msl.push(iMsl >= 0 ? parseFloat(c[iMsl]) : null);
      ref.push(iRef >= 0 && c[iRef] ? parseFloat(c[iRef]) : null);
      fin.push(iFinal >= 0 ? parseFloat(c[iFinal]) : null);
    });

    new Chart(chart, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "MSL z čidla", data: msl, pointRadius: 0 },
          { label: "Chotusice", data: ref, pointRadius: 0 },
          { label: "Finální tlak", data: fin, pointRadius: 0 }
        ]
      },
      options: {
        plugins: { legend: { position: "bottom" } },
        scales: { x: { display: false } }
      }
    });
  })
  .catch(e => {
    document.getElementById("info").innerHTML =
      "❌ CHYBA: " + e;
  });
</script>

</body>
</html>
